<!DOCTYPE html>
<html>
<head>
    <title>Fructify</title>

    <link href="style.css" rel="stylesheet">
</head>
<body>

    <p>Click on a pixel to change it's colour.</p>

    <div id="canvas">
        <!--
        <i></i>
        -->
    </div>

    <p><span id="connection-count">0</span> artists painting</p>


    <script type="text/javascript">

        webSocketConnect = (function() {
            if ("WebSocket" in window) {
                console.log("WebSocket is supported by your Browser!");
           
                // Let us open a web socket
                window.ws = new WebSocket("ws://192.168.2.99:8002");

                window.ws.onopen = function () {
                    // Web Socket is connected, send data using send()
                    //window.ws.send("Message to send");
                    console.log("Connection established...");
                };

                window.ws.onmessage = function (evt) { 
                    var received_msg = evt.data;

                    var data = JSON.parse(received_msg);

                    if (data.action == 'render-canvas') {
                        renderWholeCanvas( data.pixelString );
                    }

                    if (typeof data.connectionCount !== 'undefined') {
                        document.getElementById('connection-count').innerHTML = data.connectionCount;
                    }


                };

                window.ws.onclose = function () { 
                    // websocket is closed.
                    console.log("Connection is closed..."); 
                }

            } else {
                // The browser doesn't support WebSocket
                alert("WebSocket NOT supported by your Browser!");
            }
        })();

        function processInput(){
            //console.log( this.value );
            //window.ws.send(this.value);
        }

        function colorPixel( pixel ) {
            console.log('Setting pixel ' + pixel.dataset.index);
            if( pixel.className == 'on' ){
                pixel.className = '';
            } else {
                pixel.className = 'on';
            }
            sendPixelColor(pixel);
        }


        /**
         * Sends the state of 1 single pixel to a server
         */
        function sendPixelColor(pixel) {
            var data = {
                action: 'set-pixel',
                index: pixel.dataset.index,
                value: 0
            };

            if (pixel.className === 'on') {
                data.value = 1;
            }

            var json = JSON.stringify(data);

            window.ws.send(json);
        }


        /**
         * Communicates the state of every pixel on the whole canvas to the WS server
         */
        function sendCanvasColors(){
            var pixels = document.getElementsByTagName('i');

            var pixelString = '';
            for (var i = 0, iLimit = pixels.length; i < iLimit; i++) {
                if( pixels[i].className == 'on' ){
                    pixelString += '1';
                } else {
                    pixelString += '0';
                }
            }
            // console.log(pixelString);
            window.ws.send(pixelString);
        }

        function renderWholeCanvas( pixelString ){
            console.log('Rendering whole canvas');
            var pixels = document.getElementsByTagName('i');
            for( var i = 0, iLimit = pixelString.length; i < iLimit; i++ ){
                if( pixelString[i] == '1' ){
                    pixels[i].className = 'on';
                } else {
                    pixels[i].className = '';
                }
            }
        }

        //document.getElementById('message').addEventListener('keyup', processInput, false );

        document.onunload = function(){ window.ws.close() };

        canvas = document.getElementById('canvas');

        function populateCanvas(rowCount, colCount) {

            var pixelsCreatedCount = 0;
            var i;

            for (var r = 0; r < rowCount; r++) {
                //row = document.createElement('div');
                //canvas.appendChild(row);
                //row.className = 'row';
                for (var col = 0; col < colCount; col++) {
                    i = document.createElement('i');
                    i.dataset.index = pixelsCreatedCount;
                    canvas.appendChild(i);
                    i.addEventListener('mouseup', function () {
                        colorPixel(this)
                    }, false);
                    pixelsCreatedCount++;
                }
            }

            console.log('Populated ' + pixelsCreatedCount + ' pixels');
        }

        var rowCount = 50;
        var colCount = 70;

        populateCanvas(rowCount, colCount);

    </script>
  
</body>
</html>
